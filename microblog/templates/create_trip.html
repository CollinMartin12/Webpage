{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Create New Trip</h2>
    
    <form class="Trip-form" action="{{ url_for('main.create_trip') }}" method="post" novalidate>
        
        <div class="trip-grid">
            <div class="trip-grid-left">
                <div class="form-group">
                    <label for="title">Trip Name</label>
                    <input type="text" class="form-control-compact" id="title" name="title" maxlength="100" required placeholder="Enter trip name">
                </div>

                <div class="form-group">
                    <label>Date Type</label>
                    <div class="radio-group-compact">
                        <div class="form-check-inline">
                            <input class="form-check-input" type="radio" name="date_type" id="date_fixed" value="Fixed" required>
                            <label class="form-check-label" for="date_fixed">Fixed</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input" type="radio" name="date_type" id="date_range" value="Range" required checked>
                            <label class="form-check-label" for="date_range">Range</label>
                        </div>
                    </div>
                </div>

                <div id="view-fixed-date" style="display: none;">
                    <div class="form-group">
                        <label for="definite_date">Date</label>
                        <input type="date" class="form-control-compact" id="definite_date" name="definite_date">
                    </div>
                </div>

                <div id="view-range-date" style="display: none;">
                    <div class="form-group">
                        <label for="start_date">Start Date</label>
                        <input type="date" class="form-control-compact" id="start_date" name="start_date">
                    </div>
                    <div class="form-group">
                        <label for="end_date">End Date</label>
                        <input type="date" class="form-control-compact" id="end_date" name="end_date">
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="trip-grid-right">
                <div class="form-group">
                    <label for="destination_city_id">Main Location</label>
                    <select class="form-control-compact" id="destination_city_id" name="destination_city_id">
                        <option value="">Select departure city</option>
                        {% for city in cities %}
                            <option value="{{ city.id }}">{{ city.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea class="form-control-compact" id="description" name="description" rows="3" maxlength="256" required placeholder="Trip description..."></textarea>
                </div>

                <div class="form-group">
                    <label for="max_participants">Max Participants</label>
                    <input type="number" class="form-control-compact" id="max_participants" name="max_participants" min="1" placeholder="Leave empty for unlimited">
                </div>
            </div>
        </div>


        <!-- Stops Section -->
        <div class="form-section">
            <h3>Stops</h3>
            <div id="stopsContainer">
                <div class="stop-card" data-stop-index="0">
                    <div class="stop-header">
                        <h4 class="stop-number">1. Food stop</h4>
                        <button type="button" class="remove-stop" style="display: none;">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                            Remove
                        </button>
                    </div>
                    <div class="form-group">
                        <div class="radio-group-compact">
                            <div class="form-check-inline">
                                <input class="form-check-input" type="radio" name="stops[0].stop_status" id="destination_fixed" value="Fixed" required>
                                <label class="form-check-label" for="destination_fixed">Final</label>
                            </div>
                            <div class="form-check-inline">
                                <input class="form-check-input" type="radio" name="stops[0].stop_status" id="destination_open" value="Open" required>
                                <label class="form-check-label" for="destination_open">Open</label>
                            </div>
                        </div>
                    </div>
                    
                    
                    <input type="hidden" name="stops[0][stop_order]" class="stop-order" value="0">
                    
                    <div class="stop-grid">
                        <div class="stop-grid-left">
                            <div class="form-group">
                                <label>Stop Name</label>
                                <input type="text" class="form-control-compact" name="stops[0][stop_name]" maxlength="256" placeholder="Restaurant or location name">
                            </div>
                            
                            <div id="final-destination-open" style="display: none;">
                                <div class="form-group">
                                    <label for="trip_preferences">Stop Preferences</label>
                                    <input type="text" class="form-control-compact" id="trip_preferences" name="stops[0][trip_preferences]" maxlength="256" placeholder="E.g., 'Anywhere with beaches'">
                                </div>
                            </div>
                            <div id="final-destination-section" style="display: none;">
                                <div class="form-group">
                                    <label for="destination_city_id">Final Place</label>
                                        <input type="text" class="form-control-compact" id="stop_place" name="stops[0][stop_place]" maxlength="256" placeholder="E.g., 'San Gines'">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Time</label>
                                <input type="time" class="form-control-compact" name="stops[0][stop_time]">
                            </div>


                        </div>

                        <div class="stop-grid-right">
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-control-compact" name="stops[0][notes]" rows="4" maxlength="500" placeholder="Additional details..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Budget</label>
                                <input type="number" class="form-control-compact" name="stops[0][budget]" step="0.01" min="0" placeholder="0.00">
                            </div>

                            <div class="form-group">
                                <label>Stop Type</label>
                                <select class="form-control-compact" name="stops[0][stop_type]">
                                    {% for stop_type in stop_types %}
                                        <option value="{{ stop_type }}">{{ stop_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" id="addStopBtn" class="add-stop-btn">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Add another stop
            </button>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-submit">Create Trip</button>
            <a href="{{ url_for('main.index') }}" class="btn-cancel">Cancel</a>
        </div>
    </form>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const MAX_STOPS = 3;
    let stopCount = 1;

    const addStopBtn = document.getElementById('addStopBtn');
    const stopsContainer = document.getElementById('stopsContainer');

    addStopBtn.addEventListener('click', function() {
        const currentStops = stopsContainer.querySelectorAll('[data-stop-index]').length;

        if (currentStops >= MAX_STOPS) {
            alert(`You can only add up to ${MAX_STOPS} stops per trip.`);
            return;
        }

        const template = document.querySelector('[data-stop-index="0"]');
        const newStop = template.cloneNode(true);

        newStop.setAttribute('data-stop-index', stopCount);
        newStop.innerHTML = newStop.innerHTML.replace(/stops\[0\]/g, `stops[${stopCount}]`);

        //reseting the input of the stop
        newStop.querySelectorAll('input, textarea, select').forEach(input => {
            if (input.type === 'radio' || input.type === 'checkbox') {
                input.checked = false;
            } else {
                input.value = '';
            }
        });

        stopsContainer.appendChild(newStop);
        stopCount++;
        updateNumbers();

        //reaching maximum stops
        if (stopsContainer.querySelectorAll('[data-stop-index]').length >= MAX_STOPS) {
            addStopBtn.disabled = true;
            addStopBtn.classList.add('disabled');
        }
    });

    stopsContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-stop')) {
            e.target.closest('[data-stop-index]').remove();
            updateNumbers();

            // if a stop was removed we can add one again
            if (stopsContainer.querySelectorAll('[data-stop-index]').length < MAX_STOPS) {
                addStopBtn.disabled = false;
                addStopBtn.classList.remove('disabled');
            }
        }
    });

    function updateNumbers() {
        const stops = stopsContainer.querySelectorAll('[data-stop-index]');
        stops.forEach((stop, i) => {
            stop.querySelector('.stop-number').textContent = `${i + 1}. Food stop`;
            stop.querySelector('.stop-order').value = i;
            stop.querySelector('.remove-stop').style.display = stops.length > 1 ? 'flex' : 'none';
        });
    }

    updateNumbers();
});



document.addEventListener('DOMContentLoaded', function() {
    const definiteDate = document.getElementById('definite_date');
    const startDate = document.getElementById('start_date');
    const endDate = document.getElementById('end_date');
    
    function handleDateTypeChange(value) {
        document.getElementById('view-fixed-date').style.display = 'none';
        document.getElementById('view-range-date').style.display = 'none';
        
        if (definiteDate) definiteDate.removeAttribute('required');
        if (startDate) startDate.removeAttribute('required');
        if (endDate) endDate.removeAttribute('required');
        
        if (value === 'Fixed') {
            document.getElementById('view-fixed-date').style.display = 'block';
            if (definiteDate) definiteDate.setAttribute('required', 'required');
        } else if (value === 'Range') {
            document.getElementById('view-range-date').style.display = 'block';
            if (startDate) startDate.setAttribute('required', 'required');
            if (endDate) endDate.setAttribute('required', 'required');
        }
    }
    
    handleDateTypeChange('Range');
    
    document.querySelectorAll('input[name="date_type"]').forEach(radio => {
        radio.addEventListener('click', function() {
            handleDateTypeChange(this.value);
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const destinationCitySelect = document.getElementById('destination_city_id');
    
    function handleDestinationTypeChange(value) {
        document.getElementById('final-destination-section').style.display = 'none';
        document.getElementById('final-destination-open').style.display = 'none';
        
        if (destinationCitySelect) destinationCitySelect.removeAttribute('required');
        
        if (value === 'Fixed') {
            document.getElementById('final-destination-section').style.display = 'block';
            if (destinationCitySelect) destinationCitySelect.setAttribute('required', 'required');
        } else if (value === 'Open') {
            document.getElementById('final-destination-open').style.display = 'block';
        }
    }
    
    handleDestinationTypeChange('Fixed');
    
    document.querySelectorAll('input[name="destination_type"]').forEach(radio => {
        radio.addEventListener('click', function() {
            handleDestinationTypeChange(this.value);
        });
    });
});
</script>
{% endblock %}