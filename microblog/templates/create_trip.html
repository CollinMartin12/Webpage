{% extends 'base.html' %}
{% block content %}
<!-- This is the main logic for the create trip form -->

<div class="container">
    <h2>Create New Trip</h2>

    <form class="Trip-form" action="{{ url_for('main.create_trip') }}" method="post" novalidate>
        <div class="trip-grid">
        <div class="trip-grid-left">
            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <label for="title">Trip Name</label>
                    <input type="checkbox" name="final_name" id="trip_fixed" value="fixed">
                    <span style="font-size: 14px;">Fixed</span>
                </div>
                <input type="text" class="form-control-compact" id="title" name="title" maxlength="100" required placeholder="Enter trip name">
                </div>

                <div class="form-group">
                    <label>Date Type</label>
                    <div class="radio-group-compact">
                        <div class="form-check-inline">
                            <input class="form-check-input" type="radio" name="date_type" id="date_fixed" value="Fixed" required>
                            <label class="form-check-label" for="date_fixed">Fixed</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input" type="radio" name="date_type" id="date_range" value="Range" checked required>
                            <label class="form-check-label" for="date_range">Range</label>
                        </div>
                    </div>
                </div>

                <div id="view-fixed-date" style="display: none;">
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <label for="definite_date">Date</label>
                            <input type="checkbox" name="final_date" id="date_fixed_checkbox" value="fixed">
                            <span style="font-size: 14px;">Fixed</span>
                        </div>
                        <input type="date" class="form-control-compact" id="definite_date" name="definite_date">
                    </div>
                </div>

                <div id="view-range-date" style="display: none;">
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <label for="start_date">Date Range</label>
                            <input type="checkbox" name="final_date" id="date_range_checkbox" value="fixed">
                            <span style="font-size: 14px;">Fixed</span>
                        </div>
                        <input type="date" class="form-control-compact" id="start_date" name="start_date">
                    </div>
                    <div class="form-group">
                        <label for="end_date">End Date</label>
                        <input type="date" class="form-control-compact" id="end_date" name="end_date">
                    </div>
                </div>
            </div>

            <div class="trip-grid-right">
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <label for="destination_city_id">Main Location</label>
                        <input type="checkbox" name="final_location" id="destination_fixed" value="fixed">
                        <span style="font-size: 14px;">Fixed</span>
                    </div>
                    <select class="form-control-compact" id="destination_city_id" name="destination_city_id" required>
                        <option value="">Select city</option>
                        {% for city in cities %}
                            <option value="{{ city.id }}">{{ city.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <label for="description">Description</label>
                        <input type="checkbox" name="final_description" id="description_fixed" value="fixed">
                        <span style="font-size: 14px;">Fixed</span>
                    </div>
                    <textarea class="form-control-compact" id="description" name="description" rows="3" required placeholder="Trip description..."></textarea>
                </div>

                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <label for="max_participants">Max Participants</label>
                        <input type="checkbox" name="final_max_participants" id="max_participants_fixed" value="fixed">
                        <span style="font-size: 14px;">Fixed</span>
                    </div>
                    <input type="number" class="form-control-compact" id="max_participants" name="max_participants" placeholder="Leave empty for unlimited">
                </div>
            </div>
        </div>


        <div class="form-section">
            <h3>Stops</h3>
            <p> You can add up to 3 food stops for this trip.</p>

        <div id="stopsContainer">
            {% for i in range(3) %}
                <div class="stop-card">
                    <div class="stop-header">
                        <h4 class="stop-number">{{ i + 1 }}. Food stop</h4>
                    </div>

                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <label>Stop Status</label>
                            <input type="checkbox" name="stops[{{ i }}][final_stop]" id="stop_fixed_{{ i }}" value="fixed">
                            <span style="font-size: 14px;">Fixed</span>
                        </div>
                    </div>
                    
                    <input type="hidden" name="stops[{{ i }}][stop_order]" class="stop-order" value="{{ i }}">
                    
                    <div class="stop-grid">
                        <!-- Left Column -->
                        <div class="stop-grid-left">
                            <div class="form-group">
                                <label>Stop Name</label>
                                <input type="text" class="form-control-compact" name="stops[{{ i }}][stop_name]" maxlength="256" placeholder="Restaurant or location name">
                            </div>
                        
                            
                            <div class="form-group">
                                <label for="stop_place_{{ i }}">Final Place</label>
                                <input type="text" class="form-control-compact" id="stop_place_{{ i }}" name="stops[{{ i }}][stop_place]" maxlength="256" placeholder="E.g., 'San Gines'">
                            </div>

                            <div class="form-group">
                                <label>Time</label>
                                <input type="time" class="form-control-compact" name="stops[{{ i }}][stop_time]">
                            </div>
                        </div>

                        <div class="stop-grid-right">
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-control-compact" name="stops[{{ i }}][notes]" rows="4" maxlength="500" placeholder="Additional details..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Budget</label>
                                <input type="number" class="form-control-compact" name="stops[{{ i }}][budget]" step="0.01" min="0" placeholder="0.00">
                            </div>

                            <div class="form-group">
                                <label>Stop Type</label>
                                <select class="form-control-compact" name="stops[{{ i }}][stop_type]">
                                    {% for stop_type in stop_types %}
                                        <option value="{{ stop_type }}">{{ stop_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- All 3 stops are always displayed above -->
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-submit">Create Trip</button>
            <a href="{{ url_for('main.index') }}" class="btn-cancel">Cancel</a>
        </div>
    </form>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to handle date type change
    function handleDateTypeChange(value) {
        const fixedSection = document.getElementById('view-fixed-date');
        const rangeSection = document.getElementById('view-range-date');
        const definiteDate = document.getElementById('definite_date');
        const startDate = document.getElementById('start_date');
        const endDate = document.getElementById('end_date');
        
        // Hide both sections first
        if (fixedSection) fixedSection.style.display = 'none';
        if (rangeSection) rangeSection.style.display = 'none';
        
        // Remove all required attributes
        if (definiteDate) definiteDate.removeAttribute('required');
        if (startDate) startDate.removeAttribute('required');
        if (endDate) endDate.removeAttribute('required');
        
        // Show appropriate section and set required
        if (value === 'Fixed' && fixedSection) {
            fixedSection.style.display = 'block';
            if (definiteDate) definiteDate.setAttribute('required', 'required');
        } else if (value === 'Range' && rangeSection) {
            rangeSection.style.display = 'block';
            if (startDate) startDate.setAttribute('required', 'required');
            if (endDate) endDate.setAttribute('required', 'required');
        }
    }
    
    // Initialize date display - default to Range for new trips
    handleDateTypeChange('Range');    
    
    // Add event listeners for date type change
    document.querySelectorAll('input[name="date_type"]').forEach(radio => {
        radio.addEventListener('click', function() {
            handleDateTypeChange(this.value);
        });
    });
});
</script>
{% endblock %}