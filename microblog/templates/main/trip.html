{% extends 'base.html' %}

{% block content %}
<div class ="trip-details-container">
    <main>
        <header>
            <h1>Trip Details</h1>
        </header>
        <div>
           {% set trip = trip %}
          <h3 class="trip-details-title">
              {{ trip.destination_city.name if trip.destination_city else "Unknown City" }} - {{ trip.trip_type.name if trip.trip_type else "Unknown Type" }}
          </h3>
            <div class = "status">
                {{ trip.status }}
            </div>
        </div>
        <div class="trip-meta">
            <p><i> Posted at {{ trip.created_at }}</i></p>
            <p> {{trip.departure_city.name if trip.departure_city else "TBD"}} -> {{trip.destination_city.name if trip.destination_city else "TBD"}}</p>
            <p><i> Budget: {{ trip.budget if trip.budget else "NA" }}</i></p>
            <p><i> Max Participants: {{ trip.max_participants if trip.max_participants else "Unlimited" }}</i></p>
        </div>

            <div class="trip-details-image">
                <img src="{{ trip.picture if trip.picture else '' }}">
            </div>
            <h3 class="trip-description-title">About this Trip:</h3>
            <p class="trip-description">{{ trip.description }}</p>

        <div class="participants-display">
            <span>Participants: </span>
            {% if trip.participants | length > 0 %}
                <div class="participant-avatars">
                    <div class="avatar-small">
                        {% for participant in trip.participants[:4] %}
                            <img src="{{ participant.profile_picture or '/static/default-avatar.png' }}" alt="{{ participant.name }}">
                        {% endfor %}
                    </div>
                    {% if trip.participants | length > 4 %}
                        <span class= "participant-count">+{{ trip.participants | length - 4 }}</span>
                    {% endif %}
                </div>
            {% else %}
                <span>No participants yet</span>
            {% endif %}
        </div>
        <div class = "meetups_section">
            <h3>Meetups ({{ trip.meetups|length }})</h3>
            {% if trip.meetups | length > 0 %}
                <ul>
                    {% for meetup in trip.meetups %}
                        <li>
                            <strong>{{ meetup.title }}</strong> - {{ meetup.date }} at {{ meetup.location }}
                            <p>{{ meetup.description }}</p>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No meetups scheduled yet.</p>
            {% endif %}
        </div>

        <div class="trip-actions">
            <!-- Edit button - should disappear for EVERYONE if trip is finalized/canceled -->
            {% if has_editing_permissions and trip.status != "Canceled" and trip.status != "Done" %}
                <a href="{{ url_for('main.edit_trip', trip_id=trip.id) }}" 
                class="btn btn--warning">
                    Edit Trip
                </a>
            {% endif %}

            {% if not is_creator %}
                {% if is_participant %}
                    <!-- Leave button - only for active trips -->
                    {% if trip.is_open and trip.status != "Canceled" and trip.status != "Done" %}
                        {% if not is_only_editor %}
                            <a href="{{ url_for('main.leave_trip', trip_id=trip.id) }}"
                            class="btn btn--danger"
                            onclick="return confirm('Are you sure you want to leave this trip?')">
                                Leave Trip
                            </a>
                        {% else %}
                            <span class="text-muted" style="font-size: 0.9em;">
                                You cannot leave because you are the only editor.
                            </span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted" style="font-size: 0.9em;">
                            {% if trip.status == "Canceled" %}
                                This trip has been canceled.
                            {% elif trip.status == "Done" %}
                                This trip has been completed.
                            {% else %}
                                Trip is no longer active for changes. {{trip.is_open}}
                            {% endif %}
                        </span>
                    {% endif %}
                {% else %}
                    <!-- Join button - only for active trips -->
                    {% if trip.is_open and trip.status != "Canceled" and trip.status != "Done" %}
                        <a href="{{ url_for('main.join_trip', trip_id=trip.id) }}"
                        class="btn btn-success">
                            Join Trip
                        </a>
                    {% else %}
                        <span class="text-muted" style="font-size: 0.9em;">
                            {% if trip.status == "Canceled" %}
                                This trip has been canceled.
                            {% elif trip.status == "Done" %}
                                This trip has been completed.
                            {% else %}
                                This trip is closed to new participants.
                            {% endif %}
                        </span>
                    {% endif %}
                {% endif %}
            {% else %}
                <span class="badge badge-primary">You created this trip</span>
            {% endif %}

            <!-- Admin actions - Only show for creators/editors on Planning trips -->
            {% if (has_editing_permissions or is_creator) and trip.status == "Planning" %}
                {% if trip.is_open %}
                    <a href="{{ url_for('main.finalize_trip', trip_id=trip.id) }}" 
                    class="btn btn-success"
                    onclick="return confirm('Are you sure you want to finalize this trip? This action cannot be undone.')">
                        Finalize Trip
                    </a>
                {% endif %}

                <a href="{{ url_for('main.cancel_trip', trip_id=trip.id) }}" 
                class="btn btn-danger"
                onclick="return confirm('Are you sure you want to cancel this trip? This action cannot be undone.')">
                    Cancel Trip
                </a>
            {% endif %}

            <!-- Reopen button - Only for creators on canceled trips -->
            {% if trip.status == "Canceled" and is_creator %}
                <a href="{{ url_for('main.reopen_trip', trip_id=trip.id) }}" 
                class="btn btn-warning"
                onclick="return confirm('Are you sure you want to reopen this trip?')">
                    Reopen Trip
                </a>
            {% endif %}

            <!-- Status messages for non-creators -->
            {% if trip.status == "Canceled" and not is_creator %}
                <p class="text-muted">This trip has been <strong>canceled</strong>. Only the creator can reopen it.</p>
            {% elif trip.status == "Done" %}
                <p class="text-muted">This trip has been <strong>completed</strong>.</p>
            {% endif %}
        </div>

        <!-- Message Board - Read-only for finalized/canceled trips -->
        <section id="comments" class="trip-comments">
            <h3 class="trip-comments__title">Message Board</h3>
            
            <!-- Only show form for participants on active trips -->
            {% if (is_creator or is_participant) and trip.status != "Canceled" and trip.status != "Done" %}
                <form class="trip-comments__form"
                        method="post"
                        action="{{ url_for('main.new_message', trip_id=trip.id) }}">
                    <input type="hidden" name="trip_id" value="{{ trip.id }}">
                    <textarea name="content" rows="3" maxlength="1000"
                            placeholder="Write a messageâ€¦" required></textarea>
                    <div class="trip-comments__form-actions">
                        <button type="submit">Post</button>
                    </div>
                </form>
            {% elif trip.status == "Canceled" or trip.status == "Done" %}
                <p class="text-muted">
                    <em>Message board is read-only for {{ "canceled" if trip.status == "Canceled" else "completed" }} trips.</em>
                </p>
            {% endif %}

            <!-- Show messages to participants -->
            {% if is_creator or is_participant %}
                <div class="trip-comments__list">
                    {% for comment in trip.comments %}
                        {% include 'messages.html' %}
                    {% else %}
                        <p class="trip-comments__empty">No messages yet.</p>
                    {% endfor %}
                </div>
            {% else %}
                <p class="trip-comments__empty">Join the trip to view and post messages.</p>
            {% endif %}
        </section>
    </main>


</div>
{% endblock %}
