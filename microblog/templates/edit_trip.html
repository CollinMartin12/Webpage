{% extends 'base.html' %}
{% block content %}
<!-- This is the main logic of the edit trip page -->

<div class="container">
    <h2>Edit Trip</h2>

    <form class="Trip-form" action="{{ url_for('main.edit_trip', trip_id=trip.id) }}" method="post" novalidate>
        <div class="trip-grid">
        <div class="trip-grid-left">
            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <label for="title">Trip Name</label>
                    <input type="checkbox" name="final_name" id="trip_fixed" value="fixed" {% if trip.final_name %}checked disabled{% endif %}>
                    <span style="font-size: 14px;">Fixed</span>
                </div>
                <input type="text" class="form-control-compact" id="title" name="title" maxlength="100" required {% if trip.final_name %}readonly style="background-color: #f8f9fa;"{% endif %} placeholder="Enter trip name" value="{{ trip.title }}">
                </div>

                <div class="form-group">
                    <label>Date Type</label>
                    <div class="radio-group-compact">
                        <div class="form-check-inline">
                            <input class="form-check-input" type="radio" name="date_type" id="date_fixed" value="Fixed" {% if date_type == "Fixed" %}checked{% endif %} required>
                            <label class="form-check-label" for="date_fixed">Fixed</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input" type="radio" name="date_type" id="date_range" value="Range" {% if date_type == "Range" %}checked{% endif %} required>
                            <label class="form-check-label" for="date_range">Range</label>
                        </div>
                    </div>
                </div>

                <div id="view-fixed-date" style="{% if date_type != 'Fixed' %}display: none;{% endif %}">
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <label for="definite_date">Date</label>
                            <input type="checkbox" name="final_date" id="date_fixed_checkbox" value="fixed" {% if trip.final_date %}checked disabled{% endif %}>
                            <span style="font-size: 14px;">Fixed</span>
                        </div>
                        <input type="date" class="form-control-compact" id="definite_date" name="definite_date" value="{{ trip.definite_date }}" {% if trip.final_date %}readonly style="background-color: #f8f9fa;"{% endif %}>
                    </div>
                </div>

                <div id="view-range-date" style="{% if date_type != 'Range' %}display: none;{% endif %}">
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <label for="start_date">Date Range</label>
                            <input type="checkbox" name="final_date" id="date_range_checkbox" value="fixed" {% if trip.final_date %}checked disabled{% endif %}>
                            <span style="font-size: 14px;">Fixed</span>
                        </div>
                        <input type="date" class="form-control-compact" id="start_date" name="start_date" value="{{ trip.start_date }}" {% if trip.final_date %}readonly style="background-color: #f8f9fa;"{% endif %}>
                    </div>
                    <div class="form-group">
                        <label for="end_date">End Date</label>
                        <input type="date" class="form-control-compact" id="end_date" name="end_date" value="{{ trip.end_date }}" {% if trip.final_date %}readonly style="background-color: #f8f9fa;"{% endif %}>
                    </div>
                </div>
            </div>

            <div class="trip-grid-right">
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <label for="destination_city_id">Main Location</label>
                        <input type="checkbox" name="final_location" id="destination_fixed" value="fixed" {% if trip.final_location %}checked disabled{% endif %}>
                        <span style="font-size: 14px;">Fixed</span>
                    </div>
                    {% if trip.final_location %}
                        <input type="text" class="form-control-compact" value="{{ trip.destination_city.name if trip.destination_city else 'No city selected' }}" readonly style="background-color: #f8f9fa;">
                        <input type="hidden" name="destination_city_id" value="{{ trip.destination_city_id }}">
                    {% else %}
                        <select class="form-control-compact" id="destination_city_id" name="destination_city_id" required>
                            <option value="">Select city</option>
                            {% for city in cities %}
                                <option value="{{ city.id }}" {% if city.id == trip.destination_city_id %}selected{% endif %}>{{ city.name }}</option>
                            {% endfor %}
                        </select>
                    {% endif %}
                </div>

                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <label for="description">Description</label>
                        <input type="checkbox" name="final_description" id="description_fixed" value="fixed" {% if trip.final_description %}checked disabled{% endif %}>
                        <span style="font-size: 14px;">Fixed</span>
                    </div>
                    <textarea class="form-control-compact" id="description" name="description" rows="3" {% if trip.final_description %}readonly style="background-color: #f8f9fa;"{% endif %}>{{ trip.description }}</textarea>
                </div>

                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <label for="max_participants">Max Participants</label>
                        <input type="checkbox" name="final_max_participants" id="max_participants_fixed" value="fixed" {% if trip.final_max_participants %}checked disabled{% endif %}>
                        <span style="font-size: 14px;">Fixed</span>
                    </div>
                    <input type="number" class="form-control-compact" id="max_participants" name="max_participants" value="{{ trip.max_participants }}" {% if trip.final_max_participants %}readonly style="background-color: #f8f9fa;"{% endif %}>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="edit_permissions">Edit Permissions</label>
            <div id="edit_permissions">
            {% for participant in participants %}
                {% if participant.user.id != trip.creator_id %}
                    <div class="form-check">
                        <input class="form-check-input" 
                            type="checkbox" 
                            id="edit_permission_{{ participant.user.id }}" 
                            name="edit_permissions" 
                            value="{{ participant.user.id }}"
                            {% if participant.editing_permissions %}checked{% endif %}>
                        <label class="form-check-label" for="edit_permission_{{ participant.user.id }}">
                            {{ participant.user.name }}
                        </label>
                    </div>
                {% endif %}
            {% endfor %}
            </div>
        </div>

        <div class="form-section">
            <h3>Stops</h3>
            <p> You can add up to 3 food stops for this trip. If a stop is marked as "Fixed", its details cannot be changed.</p>

        <div id="stopsContainer">
            {% for i in range(3) %}
                {% set stop = stops[i] if i < stops|length else None %}
                <div class="stop-card">
                    <div class="stop-header">
                        <h4 class="stop-number">{{ i + 1 }}. Food stop</h4>
                        <input type="hidden" name="stops[{{ i }}][stop_id]" value="{{ stop.id if stop else '' }}">
                    </div>

                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <label>Stop Status</label>
                            <input type="checkbox" name="stops[{{ i }}][final_stop]" id="stop_fixed_{{ i }}" value="fixed" {% if stop and stop.final_stop %}checked disabled{% endif %}>
                            <span style="font-size: 14px;">Fixed</span>
                        </div>
                    </div>
                    
                    <input type="hidden" name="stops[{{ i }}][stop_order]" class="stop-order" value="{{ i }}">
                    
                    <div class="stop-grid">
                        <!-- Left Column -->
                        <div class="stop-grid-left">
                            <div class="form-group">
                                <label>Stop Name</label>
                                <input type="text" class="form-control-compact" name="stops[{{ i }}][stop_name]" maxlength="256" placeholder="Restaurant or location name" value="{{ stop.name if stop else '' }}" {% if stop and stop.final_stop %}readonly style="background-color: #f8f9fa;"{% endif %}>
                            </div>
                            
                            
                            <div class="form-group">
                                <label for="stop_place_{{ i }}">Final Place</label>
                                <input type="text" class="form-control-compact" id="stop_place_{{ i }}" name="stops[{{ i }}][stop_place]" maxlength="256" placeholder="E.g., 'San Gines'" value="{{ stop.place if stop else '' }}" {% if stop and stop.final_stop %}readonly style="background-color: #f8f9fa;"{% endif %}>
                            </div>

                            <div class="form-group">
                                <label>Time</label>
                                <input type="time" class="form-control-compact" name="stops[{{ i }}][stop_time]" value="{{ stop.time if stop else '' }}" {% if stop and stop.final_stop %}readonly style="background-color: #f8f9fa;"{% endif %}>
                            </div>
                        </div>

                        <div class="stop-grid-right">
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-control-compact" name="stops[{{ i }}][notes]" rows="4" maxlength="500" placeholder="Additional details..." {% if stop and stop.final_stop %}readonly style="background-color: #f8f9fa;"{% endif %}>{{ stop.notes if stop else '' }}</textarea>
                            </div>

                            <div class="form-group">
                                <label>Budget</label>
                                <input type="number" class="form-control-compact" name="stops[{{ i }}][budget]" step="0.01" min="0" placeholder="0.00" value="{{ stop.budget_per_person if stop else '' }}" {% if stop and stop.final_stop %}readonly style="background-color: #f8f9fa;"{% endif %}>
                            </div>

                            <div class="form-group">
                                <label>Stop Type</label>
                                <select class="form-control-compact" name="stops[{{ i }}][stop_type]" {% if stop and stop.final_stop %}disabled style="background-color: #f8f9fa;"{% endif %}>
                                    {% for stop_type in stop_types %}
                                        <option value="{{ stop_type }}" {% if stop and stop.stop_type == stop_type %}selected{% endif %}>{{ stop_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- All 3 stops are always displayed above -->
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-submit">Finish Editing</button>
            <a href="{{ url_for('main.index') }}" class="btn-cancel">Cancel</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to handle date type change
    function handleDateTypeChange(value) {
        const fixedSection = document.getElementById('view-fixed-date');
        const rangeSection = document.getElementById('view-range-date');
        const definiteDate = document.getElementById('definite_date');
        const startDate = document.getElementById('start_date');
        const endDate = document.getElementById('end_date');
        
        // Hide both sections first
        if (fixedSection) fixedSection.style.display = 'none';
        if (rangeSection) rangeSection.style.display = 'none';
        
        // Remove all required attributes
        if (definiteDate) definiteDate.removeAttribute('required');
        if (startDate) startDate.removeAttribute('required');
        if (endDate) endDate.removeAttribute('required');
        
        // Show appropriate section and set required
        if (value === 'Fixed' && fixedSection) {
            fixedSection.style.display = 'block';
            if (definiteDate) definiteDate.setAttribute('required', 'required');
        } else if (value === 'Range' && rangeSection) {
            rangeSection.style.display = 'block';
            if (startDate) startDate.setAttribute('required', 'required');
            if (endDate) endDate.setAttribute('required', 'required');
        }
    }
    
    // Check if dates are finalized
    const isFinalDate = {{ 'true' if trip.final_date else 'false' }};
    
    // Disable date type radio buttons if dates are finalized
    if (isFinalDate) {
        document.querySelectorAll('input[name="date_type"]').forEach(radio => {
            radio.disabled = true;
        });
    }
    
    // Initialize date display
    handleDateTypeChange('{{ date_type }}');    
    
    // Add event listeners if dates are not finalized
    if (!isFinalDate) {
        document.querySelectorAll('input[name="date_type"]').forEach(radio => {
            radio.addEventListener('click', function() {
                handleDateTypeChange(this.value);
            });
        });
    }
});
</script>

{% endblock %}