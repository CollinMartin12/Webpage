{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Edit Trip</h2>
    

    <form class="Trip-form" action="{{ url_for('main.edit_trip', trip_id=trip.id) }}" method="post" novalidate>

        <div class="trip-grid">
            <div class="trip-grid-left">
                <div class="form-group">
                    <label for="title">Trip Name</label>
                    <input type="text" class="form-control-compact" id="title" name="title" maxlength="100" required readonly placeholder="Enter trip name" value="{{ trip.title }}">
                </div>

                {% if date_type == "Fixed" %}
                    <div class="form-group">
                        <label for="definite_date">Date</label>
                        <input type="date" class="form-control-compact" id="definite_date" name="definite_date" value="{{ trip.definite_date }}" readonly>
                    </div>
                {% else %}
                    <div class="form-group">
                        <label for="start_date">Start Date</label>
                        <input type="date" class="form-control-compact" id="start_date" name="start_date" value="{{ trip.start_date }}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="end_date">End Date</label>
                        <input type="date" class="form-control-compact" id="end_date" name="end_date" value="{{ trip.end_date }}" readonly>
                    </div>
                {% endif %}
            </div>

            <div class="trip-grid-right">
                <div class="form-group">
                    <label for="destination_city_id">Main Location</label>
                    <select class="form-control-compact" id="destination_city_id" name="destination_city_id" required>
                        <option value="">Select city</option>
                        {% for city in cities %}
                            <option value="{{ city.id }}" {% if city.id == trip.destination_city_id %}selected{% endif %}>{{ city.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea class="form-control-compact" id="description" name="description" rows="3" readonly>{{ trip.description }}</textarea>
                </div>

                <div class="form-group">
                    <label for="max_participants">Max Participants</label>
                    <input type="number" class="form-control-compact" id="max_participants" name="max_participants" value="{{ trip.max_participants }}" readonly>
                </div>
            </div>
        </div>
        <!-- here add who gets editing permissions | a list of all participants with a checkbox by their name-->
        <div class="form-group">
            <label for="edit_permissions">Edit Permissions</label>
            <div id="edit_permissions">
            {% for participant in participants %}
                {# Check if this specific participant is NOT the creator (creator always has permissions, so no checkbox needed) #}
                {% if participant.user.id != trip.creator_id %}
                    <div class="form-check">
                        <input class="form-check-input" 
                            type="checkbox" 
                            id="edit_permission_{{ participant.user.id }}" 
                            name="edit_permissions" 
                            value="{{ participant.user.id }}"
                            {% if participant.editing_permissions %}checked{% endif %}>
                        <label class="form-check-label" for="edit_permission_{{ participant.user.id }}">
                            {{ participant.user.name }}
                        </label>
                    </div>
                {% endif %}
            {% endfor %}
            </div>
        </div>

        <!-- Stops Section -->
        <div class="form-section">
            <h3>Stops</h3>

        <div id="stopsContainer">
        {# Maximum number of stops allowed #}
            {% set total_stops = stops|length if stops|length > 0 else 1 %}
            {% set max_render = total_stops + 5 %}  {# render existing + 5 new placeholders #}
            {% for i in range(max_render) %}
                {% set stop = stops[i] if i < stops|length else None %}
                <div class="stop-card"
                     data-stop-index="{{ i }}"
                     {% if i > 0 and not stop %}style="display: none;"{% endif %}>
                    <div class="stop-header">
                        <h4 class="stop-number">{{ i + 1 }}. Food stop</h4>
                        <button type="button" class="remove-stop"
                                style="display: {% if i == 0 %}none{% else %}flex{% endif %};">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                            Remove
                        </button>
                </div>



                    <div class="form-group">
                        <div class="radio-group-compact">
                            <div class="form-check-inline">
                                <input class="form-check-input stop-status-radio" type="radio" name="stops[{{ i }}][stop_status]" id="destination_fixed_{{ i }}" value="Fixed" data-stop-index="{{ i }}" required {% if stop and stop.stop_status == 'Fixed' %}checked disabled{% endif %}>
                                <label class="form-check-label" for="destination_fixed_{{ i }}">Final</label>
                            </div>
                            <div class="form-check-inline">
                                <input class="form-check-input stop-status-radio" type="radio" name="stops[{{ i }}][stop_status]" id="destination_open_{{ i }}" value="Open" data-stop-index="{{ i }}" required {% if stop and stop.stop_status == 'Open' %}checked{% endif %}{% if stop and stop.stop_status == 'Fixed' %} disabled{% endif %}>
                                <label class="form-check-label" for="destination_open_{{ i }}">Open</label>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" name="stops[{{ i }}][stop_order]" class="stop-order" value="{{ i }}">
                    
                    <div class="stop-grid">
                        <!-- Left Column -->
                        <div class="stop-grid-left">
                            <div class="form-group">
                                <label>Stop Name</label>
                                <input type="text" class="form-control-compact stop-name-input" name="stops[{{ i }}][stop_name]" maxlength="256" placeholder="Restaurant or location name" value="{{ stop.name if stop else '' }}" data-stop-index="{{ i }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>
                            </div>
                            
                            {% if i == 0 %}
                            <div id="final-destination-open-{{ i }}" class="final-destination-open" style="display: none;">
                                <div class="form-group">
                                    <label for="trip_preferences_{{ i }}">Stop Preferences</label>
                                    <input type="text" class="form-control-compact" id="trip_preferences_{{ i }}" name="trip_preferences" maxlength="256" placeholder="E.g., 'Anywhere with beaches'" value="{{ trip.trip_preferences or '' }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>
                                </div>
                            </div>
                            <div id="final-destination-section-{{ i }}" class="final-destination-section" style="display: none;">
                                <div class="form-group">
                                    <label for="stop_place_{{ i }}">Final Place</label>
                                    <input type="text" class="form-control-compact" id="stop_place_{{ i }}" name="stop_place" maxlength="256" placeholder="E.g., 'San Gines'" value="{{ stop.place if stop else '' }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>
                                </div>
                            </div>
                            {% endif %}

                            <div class="form-group">
                                <label>Time</label>
                                <input type="time" class="form-control-compact stop-time-input" name="stops[{{ i }}][stop_time]" value="{{ stop.time if stop else '' }}" data-stop-index="{{ i }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="stop-grid-right">
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-control-compact stop-notes-input" name="stops[{{ i }}][notes]" rows="4" maxlength="500" placeholder="Additional details..." data-stop-index="{{ i }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>{{ stop.notes if stop else '' }}</textarea>
                            </div>

                            <div class="form-group">
                                <label>Budget</label>
                                <input type="number" class="form-control-compact stop-budget-input" name="stops[{{ i }}][budget]" step="0.01" min="0" placeholder="0.00" value="{{ stop.budget_per_person if stop else '' }}" data-stop-index="{{ i }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>
                            </div>

                            <div class="form-group">
                                <label>Stop Type</label>
                                <select class="form-control-compact stop-type-select" name="stops[{{ i }}][stop_type]" data-stop-index="{{ i }}" {% if stop and stop.stop_status == 'Fixed' %}disabled{% endif %}>
                                    {% if not stop or stop.stop_status != 'Fixed' %}
                                        {% for stop_type in stop_types %}
                                            <option value="{{ stop_type }}" {% if stop and stop.stop_type == stop_type %}selected{% endif %}>{{ stop_type }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="{{ stop.stop_type }}" selected disabled>{{ stop.stop_type }}</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="addStopBtn" class="add-stop-btn" style="display: none;">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Add another stop
            </button>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-submit">Finish Editing</button>
            <a href="{{ url_for('main.index') }}" class="btn-cancel">Cancel</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show add button if we have less than 3 visible stops
   function updateAddButton() {
        const stops = Array.from(document.querySelectorAll('[data-stop-index]'));
        const visibleStops = stops.filter(stop => stop.style.display !== 'none');
        const addBtn = document.getElementById('addStopBtn');

        // Show add button if there are hidden stops left to reveal
        const hiddenStops = stops.filter(stop => stop.style.display === 'none');
        addBtn.style.display = hiddenStops.length > 0 ? 'flex' : 'none';
}
    
    document.getElementById('addStopBtn').addEventListener('click', function() {
        const stops = document.querySelectorAll('[data-stop-index]');
        for (let stop of stops) {
            if (stop.style.display === 'none') {
                stop.style.display = 'block';
                updateNumbers();
                updateAddButton();
                break;
            }
        }
    });
    
    document.getElementById('stopsContainer').addEventListener('click', function(e) {
        if (e.target.closest('.remove-stop')) {
            const stopCard = e.target.closest('[data-stop-index]');
            stopCard.style.display = 'none';
            // Clear values when hiding
            stopCard.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.type !== 'radio' && input.type !== 'hidden') {
                    input.value = '';
                }
            });
            updateNumbers();
            updateAddButton();
        }
    });
    
    function updateNumbers() {
        const stops = document.querySelectorAll('[data-stop-index]:not([style*="display: none"])');
        stops.forEach((stop, i) => {
            stop.querySelector('.stop-number').textContent = `${i + 1}. Food stop`;
            stop.querySelector('.remove-stop').style.display = i === 0 ? 'none' : 'flex';
        });
    }
    
    updateNumbers();
    updateAddButton();
    
    // Handle stop status changes for each stop independently
    document.querySelectorAll('.stop-status-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            const stopIndex = this.getAttribute('data-stop-index');
            const value = this.value;
            const stopCard = this.closest('.stop-card');
            
            const nameInput = stopCard.querySelector('.stop-name-input');
            const timeInput = stopCard.querySelector('.stop-time-input');
            const notesInput = stopCard.querySelector('.stop-notes-input');
            const budgetInput = stopCard.querySelector('.stop-budget-input');
            const typeSelect = stopCard.querySelector('.stop-type-select');
            
            if (value === 'Fixed') {
                if (nameInput) nameInput.readOnly = true;
                if (timeInput) timeInput.readOnly = true;
                if (notesInput) notesInput.readOnly = true;
                if (budgetInput) budgetInput.readOnly = true;
                if (typeSelect) typeSelect.disabled = true;
                
                // For stop 0, show/hide special sections
                if (stopIndex === '0') {
                    const openSection = document.getElementById(`final-destination-open-${stopIndex}`);
                    const fixedSection = document.getElementById(`final-destination-section-${stopIndex}`);
                    if (openSection) openSection.style.display = 'none';
                    if (fixedSection) fixedSection.style.display = 'block';
                }
            } else if (value === 'Open') {
                if (nameInput) nameInput.readOnly = false;
                if (timeInput) timeInput.readOnly = false;
                if (notesInput) notesInput.readOnly = false;
                if (budgetInput) budgetInput.readOnly = false;
                if (typeSelect) typeSelect.disabled = false;
                
                // For stop 0, show/hide special sections
                if (stopIndex === '0') {
                    const openSection = document.getElementById(`final-destination-open-${stopIndex}`);
                    const fixedSection = document.getElementById(`final-destination-section-${stopIndex}`);
                    if (openSection) openSection.style.display = 'block';
                    if (fixedSection) fixedSection.style.display = 'none';
                }
            }
        });
        
        // Initialize on page load
        if (radio.checked) {
            radio.dispatchEvent(new Event('change'));
        }
    });
});
</script>
{% endblock %}