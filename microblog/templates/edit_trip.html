{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Edit Trip</h2>
    <p>Update your trip details below.</p>
    <div class="basic_info">
        <form class="Trip-form" action="{{ url_for('main.edit_trip', trip_id=trip.id) }}" method="post" novalidate>
            
            <h3>Trip Basics</h3>
            <p>Plan your food stops, mark what's final and what's still undecided, and choose who can join.</p>
            <div> 
                <label for="title">Trip Name:</label>
                <input type="text" class="form-control" id="title" name="title" maxlength="100" required placeholder="Enter trip name" value="{{ trip.title }}">
            </div>

            <div class="form-group">
                <label for="trip_statuses">Trip Decision Status:</label>
                <select class="form-control" id="trip_statuses" name="trip_statuses" required>
                    <option value="">Select trip decision status</option>
                    {% for status in trip_statuses %}
                        <option value="{{ status }}" {% if status == trip.trip_state %}selected{% endif %}>{{ status }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label>Date Type:</label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="date_type" id="date_fixed" value="Fixed" {% if date_type == 'Fixed' %}checked{% endif %} required>
                        <label class="form-check-label" for="date_fixed">Fixed</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="date_type" id="date_range" value="Range" {% if date_type == 'Range' %}checked{% endif %} required>
                        <label class="form-check-label" for="date_range">Range</label>
                    </div>
                </div>
            </div>
            
            <div id="view-fixed-date" style="display: none;">
                <div class="form-group">
                    <label for="definite_date">Date:</label>
                    <input type="date" class="form-control" id="definite_date" name="definite_date" value="{{ trip.definite_date.strftime('%Y-%m-%d') if trip.definite_date else '' }}">
                </div>
            </div>

            <div id="view-range-date" style="display: none;">
                <div class="form-group">
                    <label for="start_date">Start Date:</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" value="{{ trip.start_date.strftime('%Y-%m-%d') if trip.start_date else '' }}">
                </div>
                <div class="form-group">
                    <label for="end_date">End Date:</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" value="{{ trip.end_date.strftime('%Y-%m-%d') if trip.end_date else '' }}">
                </div>
            </div>

            <!-- Main Location (Departure) -->
            <div class="form-group">
                <h3>Main Location</h3>
                <label for="departure_city_id">Departure City (Optional):</label>
                <select class="form-control" id="departure_city_id" name="departure_city_id">
                    <option value="">Select departure city</option>
                    {% for city in cities %}
                        <option value="{{ city.id }}" {% if trip.departure_city_id == city.id %}selected{% endif %}>{{ city.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Destination -->
            <div>
                <h3>Destination</h3>
                <label>Choose your destination type:</label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="destination_type" id="destination_fixed" value="Fixed" {% if destination_type == 'Fixed' %}checked{% endif %} required>
                    <label class="form-check-label" for="destination_fixed">Final</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="destination_type" id="destination_open" value="Open" {% if destination_type == 'Open' %}checked{% endif %} required>
                    <label class="form-check-label" for="destination_open">Open Destination</label>
                </div>
            </div>

            <div id="final-destination-section" style="display: none;">
                <div class="form-group">
                    <label for="destination_city_id">Final Destination City:</label>
                    <select class="form-control" id="destination_city_id" name="destination_city_id">
                        <option value="">Select final destination city</option>
                        {% for city in cities %}
                            <option value="{{ city.id }}" {% if trip.destination_city_id == city.id %}selected{% endif %}>{{ city.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div id="final-destination-open" style="display: none;">
                <div class="form-group">
                    <label for="trip_preferences">Trip Preferences:</label>
                    <input type="text" class="form-control" id="trip_preferences" name="trip_preferences" maxlength="256" placeholder="E.g., 'Anywhere with beaches'" value="{{ trip.trip_preferences or '' }}">
                </div>
            </div>

            <!-- Trip Type -->
            <div class="form-group">
                <label for="trip_type">Trip Type:</label>
                <select class="form-control" id="trip_type" name="trip_type">
                    <option value="">Select trip type</option>
                    {% for trip_type in trip_types %}
                        <option value="{{ trip_type }}" {% if trip.trip_type == trip_type %}selected{% endif %}>{{ trip_type }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Trip Details -->
            <div class="trip_details">
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea class="form-control" id="description" name="description" rows="4" maxlength="256" required placeholder="Friends trip focusing on tapas, bars, and a good time...">{{ trip.description }}</textarea>
                </div>
            </div>
            
            <div>
                <div class="form-group">
                    <label for="max_participants">Max Participants (Optional):</label>
                    <input type="number" class="form-control" id="max_participants" name="max_participants" min="1" placeholder="Leave empty for unlimited" value="{{ trip.max_participants or '' }}">
                </div>
            </div>

            <!-- Additional trip details based on planning status -->
            <div class="hidden" id="view-final" style="display: none;">
                <h3>Final Trip Details</h3>
                <div class="additional_info">
                    <div class="form-group">
                        <label for="restaurant_name">Restaurant Name:</label>
                        <input type="text" class="form-control" id="restaurant_name" name="restaurant_name" maxlength="256" value="{{ trip.restaurant_name or '' }}">
                    </div>

                    <div class="form-group">
                        <label for="budget">Budget ($):</label>
                        <input type="number" class="form-control" id="budget" name="budget" step="0.01" min="0" value="{{ trip.budget or '' }}">
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="is_open_final" name="is_open" {% if trip.is_open %}checked{% endif %}>
                            <label class="form-check-label" for="is_open_final">Trip is open for participants</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="hidden" id="view-tentative" style="display: none;">
                <h3>Tentative Trip Details</h3>
                <div class="additional_info">
                    <h3>Additional Information</h3>
                    <div class="form-group">
                        <label for="restaurant_name_tentative">Restaurant Name:</label>
                        <input type="text" class="form-control" id="restaurant_name_tentative" name="restaurant_name" maxlength="256" value="{{ trip.restaurant_name or '' }}">
                    </div>

                    <div class="form-group">
                        <label for="budget_tentative">Budget ($):</label>
                        <input type="number" class="form-control" id="budget_tentative" name="budget" step="0.01" min="0" value="{{ trip.budget or '' }}">
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="is_open_tentative" name="is_open" {% if trip.is_open %}checked{% endif %}>
                            <label class="form-check-label" for="is_open_tentative">Trip is open for participants</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="hidden" id="view-to-decide" style="display: none;">
                <h3>To Decide Trip Details</h3>
                <div class="additional_info">
                    <h3>Additional Information</h3>
                    <div class="info-display">
                        <p><strong>Restaurant Name:</strong> To be decided</p>
                    </div>

                    <div class="info-display">
                        <p><strong>Budget:</strong> To be decided</p>
                    </div>

                    <div class="info-display">
                        <p><strong>Trip Status:</strong> Open for participants (can be changed later)</p>
                    </div>

                    <div class="info-display">
                        <p><em>These details will be finalized later through collaboration with participants.</em></p>
                    </div>
                </div>
            </div>
            <!-- Add permissions -->
            <div>
                <h3>Editing Permissions</h3>
                <label>Who can edit this trip?</label>
                <div class="form-check">
                    {% for participant in trip_participants %}
                        <input class="form-check-input" type="radio" name="editing_type" id="specific_people_{{ participant.id }}" value="With Specific People" {% if editing_type == 'With Specific People' %}checked{% endif %} required>
                        <label class="form-check-label" for="specific_people_{{ participant.id }}">{{ participant.name }}</label>
                    {% endfor %}
                </div>
            </div>
            <!-- Food Stops Section -->
            <section>
                <div>
                    <div>
                        <h2>Food stops</h2>
                        <p>Add each restaurant, bar, or food event. Mark whether it's final, tentative, or still to decide.</p>
                    </div>
                </div>

                <div id="stopsContainer">
                    {% if stops %}
                        {% for stop in stops %}
                        <div data-stop-index="{{ loop.index0 }}">
                            <div>
                                <div>
                                    <label>Stop name</label>
                                    <input type="text" name="stops[{{ loop.index0 }}][name]" maxlength="256" placeholder="Tapas at Bar X" value="{{ stop.name }}">
                                </div>
                                <div>
                                    <label>Restaurant / place</label>
                                    <input type="text" name="stops[{{ loop.index0 }}][place]" maxlength="256" placeholder="Bar X" value="{{ stop.place or '' }}">
                                </div>
                            </div>

                            <div>
                                <div>
                                    <label>Date</label>
                                    <input type="date" name="stops[{{ loop.index0 }}][date]" value="{{ stop.date.strftime('%Y-%m-%d') if stop.date else '' }}">
                                </div>
                                <div>
                                    <label>Time</label>
                                    <input type="time" name="stops[{{ loop.index0 }}][time]" value="{{ stop.time.strftime('%H:%M') if stop.time else '' }}">
                                </div>
                            </div>

                            <div>
                                <div>
                                    <label>Address / link</label>
                                    <input type="text" name="stops[{{ loop.index0 }}][address]" maxlength="512" placeholder="Address or Google Maps link" value="{{ stop.address or '' }}">
                                </div>
                                <div>
                                    <label>Budget per person</label>
                                    <div>
                                        <span>€</span>
                                        <input type="number" name="stops[{{ loop.index0 }}][budget_per_person]" step="0.01" min="0" placeholder="25.00" value="{{ stop.budget_per_person or '' }}">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label>Notes</label>
                                <textarea name="stops[{{ loop.index0 }}][notes]" maxlength="1000" rows="2" placeholder="Reservation reference, dietary restrictions, special requests...">{{ stop.notes or '' }}</textarea>
                            </div>

                            <input type="hidden" name="stops[{{ loop.index0 }}][order]" value="{{ loop.index0 }}" class="stop-order" />

                            <div>
                                <button type="button" class="remove-stop" {% if loop.first and loop.last %}style="display: none;"{% endif %}>
                                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    Remove stop
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <!-- Default empty stop if no stops exist -->
                        <div data-stop-index="0">
                            <div>
                                <div>
                                    <label>Stop name</label>
                                    <input type="text" name="stops[0][name]" maxlength="256" placeholder="Tapas at Bar X">
                                </div>
                                <div>
                                    <label>Restaurant / place</label>
                                    <input type="text" name="stops[0][place]" maxlength="256" placeholder="Bar X">
                                </div>
                            </div>

                            <div>
                                <div>
                                    <label>Date</label>
                                    <input type="date" name="stops[0][date]">
                                </div>
                                <div>
                                    <label>Time</label>
                                    <input type="time" name="stops[0][time]">
                                </div>
                            </div>

                            <div>
                                <div>
                                    <label>Address / link</label>
                                    <input type="text" name="stops[0][address]" maxlength="512" placeholder="Address or Google Maps link">
                                </div>
                                <div>
                                    <label>Budget per person</label>
                                    <div>
                                        <span>€</span>
                                        <input type="number" name="stops[0][budget_per_person]" step="0.01" min="0" placeholder="25.00">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label>Notes</label>
                                <textarea name="stops[0][notes]" maxlength="1000" rows="2" placeholder="Reservation reference, dietary restrictions, special requests..."></textarea>
                            </div>

                            <input type="hidden" name="stops[0][order]" value="0" class="stop-order" />

                            <div>
                                <button type="button" class="remove-stop" style="display: none;">
                                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    Remove stop
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <button type="button" id="addStopBtn">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Add another stop
                </button>
            </section>

            <div>
                <button type="submit">Update Trip</button>
                <a href="{{ url_for('main.trip', trip_id=trip.id) }}">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[name="planning_status"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('view-final').style.display = 'none';
            document.getElementById('view-tentative').style.display = 'none';
            document.getElementById('view-to-decide').style.display = 'none';
            
            if (this.value === 'Final') {
                document.getElementById('view-final').style.display = 'block';
            } else if (this.value === 'Tentative') {
                document.getElementById('view-tentative').style.display = 'block';
            } else if (this.value === 'To Decide') {
                document.getElementById('view-to-decide').style.display = 'block';
            }
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const specificSection = document.getElementById('specific-people-section');
    const openSection = document.getElementById('open-attendance-section');
    const soloSection = document.getElementById('solo-attendance-section');

    function hideAll() {
        if (specificSection) specificSection.style.display = 'none';
        if (openSection) openSection.style.display = 'none';
        if (soloSection) soloSection.style.display = 'none';
    }

    hideAll();

    document.querySelectorAll('input[name="attendance_type"]').forEach(radio => {
        radio.addEventListener('click', function() {
            hideAll();

            if (this.value === 'With Specific People') {
                if (specificSection) specificSection.style.display = 'block';
            } else if (this.value === 'Open for all') {
                if (openSection) openSection.style.display = 'block';
            } else if (this.value === 'Going-Solo') {
                if (soloSection) soloSection.style.display = 'block';
            }
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
    let stopCount = {{ stops|length if stops else 1 }};
    
    document.getElementById('addStopBtn').addEventListener('click', function() {
        const template = document.querySelector('[data-stop-index="0"]');
        const newStop = template.cloneNode(true);
        
        newStop.setAttribute('data-stop-index', stopCount);
        newStop.innerHTML = newStop.innerHTML.replace(/stops\[0\]/g, `stops[${stopCount}]`);
        
        newStop.querySelectorAll('input, textarea').forEach(input => {
            if (input.type !== 'radio') {
                input.value = '';
            } else {
                input.checked = input.value === 'Just Ideas';
            }
        });
        
        document.getElementById('stopsContainer').appendChild(newStop);
        stopCount++;
        
        updateNumbers();
    });
    
    document.getElementById('stopsContainer').addEventListener('click', function(e) {
        if (e.target.closest('.remove-stop')) {
            e.target.closest('[data-stop-index]').remove();
            updateNumbers();
        }
    });
    
    function updateNumbers() {
        const stops = document.querySelectorAll('[data-stop-index]');
        stops.forEach((stop, i) => {
            stop.querySelector('.stop-order').value = i;
            stop.querySelector('.remove-stop').style.display = stops.length > 1 ? 'block' : 'none';
        });
    }
    
    updateNumbers();
});

document.addEventListener('DOMContentLoaded', function() {
    const dateFixed = document.getElementById('date_fixed');
    const dateRange = document.getElementById('date_range');
    const definiteDate = document.getElementById('definite_date');
    const startDate = document.getElementById('start_date');
    const endDate = document.getElementById('end_date');
    
    function handleDateTypeChange(value) {
        document.getElementById('view-fixed-date').style.display = 'none';
        document.getElementById('view-range-date').style.display = 'none';
        
        if (definiteDate) definiteDate.removeAttribute('required');
        if (startDate) startDate.removeAttribute('required');
        if (endDate) endDate.removeAttribute('required');
        
        if (value === 'Fixed') {
            document.getElementById('view-fixed-date').style.display = 'block';
            if (definiteDate) definiteDate.setAttribute('required', 'required');
        } else if (value === 'Range') {
            document.getElementById('view-range-date').style.display = 'block';
            if (startDate) startDate.setAttribute('required', 'required');
            if (endDate) endDate.setAttribute('required', 'required');
        }
    }
    
    // Show the correct date section based on initial state
    const initialDateType = document.querySelector('input[name="date_type"]:checked').value;
    handleDateTypeChange(initialDateType);
    
    document.querySelectorAll('input[name="date_type"]').forEach(radio => {
        radio.addEventListener('click', function() {
            handleDateTypeChange(this.value);
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const destinationCitySelect = document.getElementById('destination_city_id');
    
    function handleDestinationTypeChange(value) {
        document.getElementById('final-destination-section').style.display = 'none';
        document.getElementById('final-destination-open').style.display = 'none';
        
        if (destinationCitySelect) destinationCitySelect.removeAttribute('required');
        
        if (value === 'Fixed') {
            document.getElementById('final-destination-section').style.display = 'block';
            if (destinationCitySelect) destinationCitySelect.setAttribute('required', 'required');
        } else if (value === 'Open') {
            document.getElementById('final-destination-open').style.display = 'block';
        }
    }
    
    // Show the correct destination section based on initial state
    const initialDestinationType = document.querySelector('input[name="destination_type"]:checked').value;
    handleDestinationTypeChange(initialDestinationType);
    
    document.querySelectorAll('input[name="destination_type"]').forEach(radio => {
        radio.addEventListener('click', function() {
            handleDestinationTypeChange(this.value);
        });
    });
});
</script>
{% endblock %}