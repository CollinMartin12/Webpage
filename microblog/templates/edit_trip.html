{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Edit Trip</h2>

    <form class="Trip-form" action="{{ url_for('main.edit_trip', trip_id=trip.id) }}" method="post" novalidate>
        <div class="trip-grid">
            <div class="trip-grid-left">
                <div class="form-group">
                    <label for="title">Trip Name</label>
                    <input type="text" class="form-control-compact" id="title" name="title" maxlength="100" required readonly placeholder="Enter trip name" value="{{ trip.title }}">
                </div>

                {% if date_type == "Fixed" %}
                    <div class="form-group">
                        <label for="definite_date">Date</label>
                        <input type="date" class="form-control-compact" id="definite_date" name="definite_date" value="{{ trip.definite_date }}" readonly>
                    </div>
                {% else %}
                    <div class="form-group">
                        <label for="start_date">Start Date</label>
                        <input type="date" class="form-control-compact" id="start_date" name="start_date" value="{{ trip.start_date }}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="end_date">End Date</label>
                        <input type="date" class="form-control-compact" id="end_date" name="end_date" value="{{ trip.end_date }}" readonly>
                    </div>
                {% endif %}
            </div>

            <div class="trip-grid-right">
                <div class="form-group">
                    <label for="destination_city_id">Main Location</label>
                    <select class="form-control-compact" id="destination_city_id" name="destination_city_id" required>
                        <option value="">Select city</option>
                        {% for city in cities %}
                            <option value="{{ city.id }}" {% if city.id == trip.destination_city_id %}selected{% endif %}>{{ city.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea class="form-control-compact" id="description" name="description" rows="3" readonly>{{ trip.description }}</textarea>
                </div>

                <div class="form-group">
                    <label for="max_participants">Max Participants</label>
                    <input type="number" class="form-control-compact" id="max_participants" name="max_participants" value="{{ trip.max_participants }}" readonly>
                </div>
            </div>
        </div>

        <!-- Editing permissions list-->

        <div class="form-group">
            <label for="edit_permissions">Edit Permissions</label>
            <div id="edit_permissions">
            {% for participant in participants %}
                {# Check if this specific participant is NOT the creator (creator always has permissions, so no checkbox needed) #}
                {% if participant.user.id != trip.creator_id %}
                    <div class="form-check">
                        <input class="form-check-input" 
                            type="checkbox" 
                            id="edit_permission_{{ participant.user.id }}" 
                            name="edit_permissions" 
                            value="{{ participant.user.id }}"
                            {% if participant.editing_permissions %}checked{% endif %}>
                        <label class="form-check-label" for="edit_permission_{{ participant.user.id }}">
                            {{ participant.user.name }}
                        </label>
                    </div>
                {% endif %}
            {% endfor %}
            </div>
        </div>

        <!-- Stops Section -->
        <div class="form-section">
            <h3>Stops</h3>

        <div id="stopsContainer">
        {# Maximum number of stops allowed #}
            {% set total_stops = stops|length if stops|length > 0 else 1 %}
            {% for i in range(3) %}
                {% set stop = stops[i] if i < stops|length else None %}
                <div class="stop-card"
                    data-stop-index="{{ i }}"
                    {% if i >= stops|length %}hidden style="display:none;"{% endif %}>
                        <div class="stop-header">
                            <h4 class="stop-number">{{ i + 1 }}. Food stop</h4>
                             <button type="button" class="remove-stop"
                                    style="display: {% if i == 0 %}none{% else %}flex{% endif %};">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                                 Remove
                        </button>
                </div>



                    <div class="form-group">
                        <div class="radio-group-compact">
                            <div class="form-check-inline">
                                <input class="form-check-input stop-status-radio" type="radio" name="stops[{{ i }}][stop_status]" id="destination_fixed_{{ i }}" value="Fixed" data-stop-index="{{ i }}" required {% if stop and stop.stop_status == 'Fixed' %}checked disabled{% endif %}>
                                <label class="form-check-label" for="destination_fixed_{{ i }}">Final</label>
                            </div>
                            <div class="form-check-inline">
                                <input class="form-check-input stop-status-radio" type="radio" name="stops[{{ i }}][stop_status]" id="destination_open_{{ i }}" value="Open" data-stop-index="{{ i }}" required {% if stop and stop.stop_status == 'Open' %}checked{% endif %}{% if stop and stop.stop_status == 'Fixed' %} disabled{% endif %}>
                                <label class="form-check-label" for="destination_open_{{ i }}">Open</label>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" name="stops[{{ i }}][stop_order]" class="stop-order" value="{{ i }}">
                    
                    <div class="stop-grid">
                        <!-- Left Column -->
                        <div class="stop-grid-left">
                            <div class="form-group">
                                <label>Stop Name</label>
                                <input type="text" class="form-control-compact stop-name-input" name="stops[{{ i }}][stop_name]" maxlength="256" placeholder="Restaurant or location name" value="{{ stop.name if stop else '' }}" data-stop-index="{{ i }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>
                            </div>
                            
                            {% if i == 0 %}
                            <div id="final-destination-open-{{ i }}" class="final-destination-open" style="display: none;">
                                <div class="form-group">
                                    <label for="trip_preferences_{{ i }}">Stop Preferences</label>
                                    <input type="text" class="form-control-compact" id="trip_preferences_{{ i }}" name="trip_preferences" maxlength="256" placeholder="E.g., 'Anywhere with beaches'" value="{{ trip.trip_preferences or '' }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>
                                </div>
                            </div>
                            <div id="final-destination-section-{{ i }}" class="final-destination-section" style="display: none;">
                                <div class="form-group">
                                    <label for="stop_place_{{ i }}">Final Place</label>
                                    <input type="text" class="form-control-compact" id="stop_place_{{ i }}" name="stop_place" maxlength="256" placeholder="E.g., 'San Gines'" value="{{ stop.place if stop else '' }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>
                                </div>
                            </div>
                            {% endif %}

                            <div class="form-group">
                                <label>Time</label>
                                <input type="time" class="form-control-compact stop-time-input" name="stops[{{ i }}][stop_time]" value="{{ stop.time if stop else '' }}" data-stop-index="{{ i }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="stop-grid-right">
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-control-compact stop-notes-input" name="stops[{{ i }}][notes]" rows="4" maxlength="500" placeholder="Additional details..." data-stop-index="{{ i }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>{{ stop.notes if stop else '' }}</textarea>
                            </div>

                            <div class="form-group">
                                <label>Budget</label>
                                <input type="number" class="form-control-compact stop-budget-input" name="stops[{{ i }}][budget]" step="0.01" min="0" placeholder="0.00" value="{{ stop.budget_per_person if stop else '' }}" data-stop-index="{{ i }}" {% if stop and stop.stop_status == 'Fixed' %}readonly{% endif %}>
                            </div>

                            <div class="form-group">
                                <label>Stop Type</label>
                                <select class="form-control-compact stop-type-select" name="stops[{{ i }}][stop_type]" data-stop-index="{{ i }}" {% if stop and stop.stop_status == 'Fixed' %}disabled{% endif %}>
                                    {% if not stop or stop.stop_status != 'Fixed' %}
                                        {% for stop_type in stop_types %}
                                            <option value="{{ stop_type }}" {% if stop and stop.stop_type == stop_type %}selected{% endif %}>{{ stop_type }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="{{ stop.stop_type }}" selected disabled>{{ stop.stop_type }}</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <button type="button" id="addStopBtn" class="add-stop-btn" style="display: flex;">

                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Add another stop
            </button>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-submit">Finish Editing</button>
            <a href="{{ url_for('main.index') }}" class="btn-cancel">Cancel</a>
        </div>
    </form>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const MAX_STOPS = 3;
    const stopsContainer = document.getElementById('stopsContainer');
    const addStopBtn = document.getElementById('addStopBtn');

    /** Return only visible stop cards (computed visibility, not style attr only) */
    function getVisibleStops() {
        return Array.from(stopsContainer.querySelectorAll('.stop-card'))
            .filter(stop => !(stop.hidden || getComputedStyle(stop).display === 'none'));
    }

    /** Return hidden stop cards */
    function getHiddenStops() {
        return Array.from(stopsContainer.querySelectorAll('.stop-card'))
            .filter(stop => (stop.hidden || getComputedStyle(stop).display === 'none'));
    }

    function updateNumbers() {
        const visibleStops = getVisibleStops();
        visibleStops.forEach((stop, i) => {
            stop.querySelector('.stop-number').textContent = `${i + 1}. Food stop`;
            const removeBtn = stop.querySelector('.remove-stop');
            if (removeBtn) removeBtn.style.display = i === 0 ? 'none' : 'flex';
        });
    }

    function updateAddButton() {
        const visibleStops = getVisibleStops();
        const hiddenStops = getHiddenStops();
        if (visibleStops.length >= MAX_STOPS || hiddenStops.length === 0) {
            addStopBtn.style.display = 'none';
        } else {
            addStopBtn.style.display = 'flex';
        }
    }

    /** When Add button clicked */
    addStopBtn.addEventListener('click', function() {
        const visibleStops = getVisibleStops();
        const hiddenStops = getHiddenStops();

        if (visibleStops.length >= MAX_STOPS) {
            alert(`You can only have up to ${MAX_STOPS} stops per trip.`);
            return;
        }
        if (hiddenStops.length === 0) {
            alert('No more stop slots available.');
            return;
        }

        const next = hiddenStops[0];
        next.hidden = false;
        next.style.display = 'block';
        updateNumbers();
        updateAddButton();
    });

    /** Remove-stop button */
    stopsContainer.addEventListener('click', function(e) {
        const btn = e.target.closest('.remove-stop');
        if (!btn) return;
        const card = btn.closest('.stop-card');
        card.hidden = true;
        card.style.display = 'none';
        card.querySelectorAll('input, textarea, select').forEach(input => {
            if (input.type !== 'radio' && input.type !== 'hidden') input.value = '';
        });
        updateNumbers();
        updateAddButton();
    });

    /** Initialize on load */
    updateNumbers();
    updateAddButton();

    /** Toggle fixed/open sections */
    document.querySelectorAll('.stop-status-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            const i = this.getAttribute('data-stop-index');
            const card = this.closest('.stop-card');
            const value = this.value;

            const name = card.querySelector('.stop-name-input');
            const time = card.querySelector('.stop-time-input');
            const notes = card.querySelector('.stop-notes-input');
            const budget = card.querySelector('.stop-budget-input');
            const type = card.querySelector('.stop-type-select');

            const openSection = document.getElementById(`final-destination-open-${i}`);
            const fixedSection = document.getElementById(`final-destination-section-${i}`);

            const toggleReadonly = (elements, state) => elements.forEach(el => { if (el) el.readOnly = state; });
            const toggleDisabled = (el, state) => { if (el) el.disabled = state; };

            if (value === 'Fixed') {
                toggleReadonly([name, time, notes, budget], true);
                toggleDisabled(type, true);
                if (openSection) openSection.style.display = 'none';
                if (fixedSection) fixedSection.style.display = 'block';
            } else {
                toggleReadonly([name, time, notes, budget], false);
                toggleDisabled(type, false);
                if (openSection) openSection.style.display = 'block';
                if (fixedSection) fixedSection.style.display = 'none';
            }
        });

        if (radio.checked) radio.dispatchEvent(new Event('change'));
    });
});
</script>

{% endblock %}